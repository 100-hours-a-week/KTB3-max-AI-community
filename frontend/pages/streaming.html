<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDF - Live Stream</title>
    <style>
        body {
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding-bottom: 50px;
            font-family: sans-serif;
        }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        select { padding: 5px 10px; font-size: 16px; }

        /* ìŠ¤íŠ¸ë¦¬ë° ì˜ìƒ */
        #video-container {
            width: 80%;
            max-width: 800px;
            aspect-ratio: 16 / 9;
            border: 2px solid #333;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 30px;
        }
        #video-stream { width: 100%; height: 100%; object-fit: contain; display: block; }
        #error-msg { color: white; position: absolute; display: none; }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .back-btn {
            margin-bottom: 20px;
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid #000;
            background-color: #f0f0f0;
            text-decoration: none;
            color: black;
        }
        .back-btn:hover { background-color: #ddd; }

        /* --- [ì¶”ê°€] ë¡œê·¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ --- */
        .log-section {
            width: 80%;
            max-width: 800px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .check-btn {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        .check-btn:hover { background-color: #0056b3; }
        .check-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- [ì¶”ê°€] ëª¨ë‹¬(íŒì—…) ìŠ¤íƒ€ì¼ --- */
        .modal {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7); /* ë°˜íˆ¬ëª… ê²€ì€ ë°°ê²½ */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            max-width: 700px;
            text-align: center;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
        video {
            width: 100%;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="controls">
        <label for="cam-select">ì¹´ë©”ë¼ ì„ íƒ:</label>
        <select id="cam-select">
            <option value="0" selected>Camera 0 (ë‚´ì¥/ê¸°ë³¸)</option>
            <option value="1">Camera 1 (ì™¸ë¶€)</option>
            <option value="99">Camera 99 (í…ŒìŠ¤íŠ¸)</option>
        </select>
        <button id="btn-refresh">ì ìš©</button>
    </div>

    <div id="video-container">
        <img id="video-stream" src="/video_feed?cam_index=0" alt="Live Video Stream">
        <div id="error-msg">ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <a href="/" class="back-btn">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    <!-- [ì¶”ê°€] íƒì§€ ë¡œê·¸ í…Œì´ë¸” ì„¹ì…˜ -->
    <div class="log-section">
        <h3>ğŸš¨ ìµœê·¼ íƒì§€ ë¡œê·¸ (ì‹¤ì‹œê°„ ì•„ë‹˜, ìƒˆë¡œê³ ì¹¨ í•„ìš”)</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ì‹œì‘ ì‹œê°„</th>
                    <th>ì¢…ë£Œ ì‹œê°„</th>
                    <th>ì´ë™ ê²½ë¡œ</th>
                    <th>ë¹„ë””ì˜¤</th>
                </tr>
            </thead>
            <tbody id="log-body">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë“¤ì–´ê° -->
            </tbody>
        </table>
    </div>

    <!-- [ì¶”ê°€] ë¹„ë””ì˜¤ ì¬ìƒ ëª¨ë‹¬ì°½ -->
    <div id="videoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">ë…¹í™” ì˜ìƒ ì¬ìƒ</h3>
            <video id="modal-player" controls>
                <source src="" type="video/mp4">
                ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </video>
        </div>
    </div>

    <script>
        // --- 1. ê¸°ì¡´ ìŠ¤íŠ¸ë¦¬ë° ë¡œì§ ---
        const camSelect = document.getElementById('cam-select');
        const btnRefresh = document.getElementById('btn-refresh');
        const videoStream = document.getElementById('video-stream');
        const errorMsg = document.getElementById('error-msg');

        btnRefresh.addEventListener('click', () => {
            const camIndex = camSelect.value;
            videoStream.style.display = 'none';
            errorMsg.style.display = 'none';
            videoStream.src = `/video_feed?cam_index=${camIndex}&t=${new Date().getTime()}`;
            videoStream.style.display = 'block';
        });

        videoStream.addEventListener('error', () => {
            videoStream.style.display = 'none';
            errorMsg.style.display = 'block';
            errorMsg.innerText = `Camera ${camSelect.value} ì—°ê²° ì‹¤íŒ¨`;
        });

        // --- 2. [ì¶”ê°€] ë¡œê·¸ í…Œì´ë¸” & ëª¨ë‹¬ ë¡œì§ ---
        const logBody = document.getElementById('log-body');
        const modal = document.getElementById('videoModal');
        const modalPlayer = document.getElementById('modal-player');
        const closeModal = document.querySelector('.close');

        // (1) ë¡œê·¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs'); // ì„œë²„ API í˜¸ì¶œ
                const data = await response.json();
                
                logBody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    // ë¹„ë””ì˜¤ íŒŒì¼ì´ ì—†ê±°ë‚˜ ë…¹í™” ì¤‘(ì¢…ë£Œì‹œê°„ ì—†ìŒ)ì´ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
                    const isVideoAvailable = row.video_filename && row.end_time;
                    
                    tr.innerHTML = `
                        <td>${row.id}</td>
                        <td>${row.start_time}</td>
                        <td>${row.end_time || "ë…¹í™” ì¤‘..."}</td>
                        <td>${row.path_log || "-"}</td>
                        <td>
                            <button 
                                class="check-btn" 
                                onclick="openModal('${row.video_filename}')"
                                ${isVideoAvailable ? '' : 'disabled'}
                            >
                                ë¹„ë””ì˜¤ í™•ì¸
                            </button>
                        </td>
                    `;
                    logBody.appendChild(tr);
                });
            } catch (error) {
                console.error('ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
            }
        }

        // (2) ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (ì „ì—­ í˜¸ì¶œì„ ìœ„í•´ windowì— ë“±ë¡)
        window.openModal = function(filename) {
            if (!filename) return;
            // ì„œë²„ì— ë§ˆìš´íŠ¸ëœ /videos ê²½ë¡œ ì‚¬ìš©
            modalPlayer.src = `/videos/${filename}`;
            modal.style.display = "block";
            modalPlayer.play(); // ìë™ ì¬ìƒ
        };

        // (3) ëª¨ë‹¬ ë‹«ê¸° ë¡œì§
        closeModal.onclick = function() {
            modal.style.display = "none";
            modalPlayer.pause(); // ë‹«ìœ¼ë©´ ì¬ìƒ ì¤‘ì§€
            modalPlayer.src = ""; // ì†ŒìŠ¤ ì´ˆê¸°í™”
        }

        // ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                modalPlayer.pause();
                modalPlayer.src = "";
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰
        fetchLogs();
        // [ì¶”ê°€] 1ì´ˆ(1000ms)ë§ˆë‹¤ ë¡œê·¸ ë¦¬ìŠ¤íŠ¸ ìë™ ê°±ì‹  í•¨ìˆ˜ ì‹¤í–‰
        setInterval(fetchLogs, 1000);
    </script>
</body>
</html>