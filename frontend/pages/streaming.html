<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDF - Live Stream</title>
    <style>
        body {
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding-bottom: 50px;
            font-family: sans-serif;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        select { padding: 5px 10px; font-size: 16px; }

        #video-container {
            width: 80%;
            max-width: 800px;
            aspect-ratio: 16 / 9;
            border: 2px solid #333;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px; /* ê°„ê²© ì¡°ì • */
        }
        #video-stream { width: 100%; height: 100%; object-fit: contain; display: block; }
        #error-msg { color: white; position: absolute; display: none; }

        /* [ìˆ˜ì •] ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ê·¸ë£¹ */
        .nav-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .nav-btn {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid #000;
            background-color: #f0f0f0;
            text-decoration: none;
            color: black;
            font-size: 14px;
            border-radius: 4px;
        }
        .nav-btn:hover { background-color: #ddd; }
        /* ê²Œì‹œíŒ ì´ë™ ë²„íŠ¼ ê°•ì¡° */
        .btn-board {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .btn-board:hover { background-color: #0056b3; }

        .log-section {
            width: 80%;
            max-width: 800px;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th { background-color: #f2f2f2; font-weight: bold; }
        
        .check-btn {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        .check-btn:hover { background-color: #0056b3; }
        .check-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            max-width: 700px;
            text-align: center;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
        video {
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        #share-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        .share-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            width: 100%;
        }
        .share-btn:hover { background-color: #218838; }

        .share-form {
            display: none;
            flex-direction: column;
            gap: 10px;
            text-align: left;
        }
        .share-form input, .share-form textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .share-form textarea { resize: vertical; height: 80px; }
        .form-row { display: flex; gap: 10px; }
        .form-row input { flex: 1; }
        
        .upload-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }
        .upload-btn:hover { background-color: #0069d9; }

    </style>
</head>
<body>

    <div class="controls">
        <label for="cam-select">ì¹´ë©”ë¼ ì„ íƒ:</label>
        <select id="cam-select">
            <option value="0" selected>Camera 0 (ë‚´ì¥/ê¸°ë³¸)</option>
            <option value="1">Camera 1 (ì™¸ë¶€)</option>
            <option value="99">Camera 99 (í…ŒìŠ¤íŠ¸)</option>
        </select>
        <button id="btn-refresh">ì ìš©</button>
    </div>

    <div id="video-container">
        <img id="video-stream" src="/video_feed?cam_index=0" alt="Live Video Stream">
        <div id="error-msg">ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <!-- [ìˆ˜ì •] ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
    <div class="nav-container">
        <a href="/" class="nav-btn">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        <a href="/board" class="nav-btn btn-board">ê²Œì‹œíŒìœ¼ë¡œ ì´ë™</a>
    </div>

    <div class="log-section">
        <h3>ğŸš¨ ìµœê·¼ íƒì§€ ë¡œê·¸ (ìë™ ê°±ì‹  ì¤‘...)</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ì‹œì‘ ì‹œê°„</th>
                    <th>ì¢…ë£Œ ì‹œê°„</th>
                    <th>ì´ë™ ê²½ë¡œ</th>
                    <th>ë¹„ë””ì˜¤</th>
                </tr>
            </thead>
            <tbody id="log-body">
            </tbody>
        </table>
    </div>

    <!-- ë¹„ë””ì˜¤ ì¬ìƒ ëª¨ë‹¬ì°½ -->
    <div id="videoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">ë…¹í™” ì˜ìƒ ì¬ìƒ</h3>
            
            <video id="modal-player" controls>
                <source src="" type="video/mp4">
                ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </video>

            <div id="share-container">
                <button id="btn-show-share" class="share-btn">ê²Œì‹œê¸€ë¡œ ê³µìœ </button>

                <div id="share-form" class="share-form">
                    <div class="form-row">
                        <input type="text" id="share-nickname" placeholder="ë‹‰ë„¤ì„" required>
                        <input type="password" id="share-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                    </div>
                    <textarea id="share-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                    <button id="btn-submit-share" class="upload-btn">ê³µìœ  (ì—…ë¡œë“œ)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const camSelect = document.getElementById('cam-select');
        const btnRefresh = document.getElementById('btn-refresh');
        const videoStream = document.getElementById('video-stream');
        const errorMsg = document.getElementById('error-msg');

        btnRefresh.addEventListener('click', () => {
            const camIndex = camSelect.value;
            videoStream.style.display = 'none';
            errorMsg.style.display = 'none';
            videoStream.src = `/video_feed?cam_index=${camIndex}&t=${new Date().getTime()}`;
            videoStream.style.display = 'block';
        });

        videoStream.addEventListener('error', () => {
            videoStream.style.display = 'none';
            errorMsg.style.display = 'block';
            errorMsg.innerText = `Camera ${camSelect.value} ì—°ê²° ì‹¤íŒ¨`;
        });

        const logBody = document.getElementById('log-body');
        const modal = document.getElementById('videoModal');
        const modalPlayer = document.getElementById('modal-player');
        const closeModal = document.querySelector('.close');
        
        const btnShowShare = document.getElementById('btn-show-share');
        const shareForm = document.getElementById('share-form');
        const btnSubmitShare = document.getElementById('btn-submit-share');
        
        let currentVideoFilename = "";

        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                logBody.innerHTML = '';

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    const isVideoAvailable = row.video_filename && row.end_time;
                    
                    tr.innerHTML = `
                        <td>${row.id}</td>
                        <td>${row.start_time}</td>
                        <td>${row.end_time || "ë…¹í™” ì¤‘..."}</td>
                        <td>${row.path_log || "-"}</td>
                        <td>
                            <button 
                                class="check-btn" 
                                onclick="openModal('${row.video_filename}')"
                                ${isVideoAvailable ? '' : 'disabled'}
                            >
                                ë¹„ë””ì˜¤ í™•ì¸
                            </button>
                        </td>
                    `;
                    logBody.appendChild(tr);
                });
            } catch (error) {
                console.error('ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
            }
        }

        window.openModal = function(filename) {
            if (!filename) return;
            currentVideoFilename = filename; 

            modalPlayer.src = `/videos/${filename}`;
            modal.style.display = "block";
            modalPlayer.play();

            btnShowShare.style.display = "block";
            shareForm.style.display = "none";
            document.getElementById('share-nickname').value = "";
            document.getElementById('share-password').value = "";
            document.getElementById('share-content').value = "";
        };

        btnShowShare.addEventListener('click', () => {
            btnShowShare.style.display = "none"; 
            shareForm.style.display = "flex";    
        });

        btnSubmitShare.addEventListener('click', async () => {
            const nickname = document.getElementById('share-nickname').value;
            const password = document.getElementById('share-password').value;
            const content = document.getElementById('share-content').value;

            if (!nickname || !password || !content) {
                alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                const response = await fetch('/api/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nickname: nickname,
                        password: password,
                        content: content,
                        video_filename: currentVideoFilename
                    })
                });

                if (response.ok) {
                    alert("ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    modal.style.display = "none";
                    modalPlayer.pause();
                } else {
                    alert("ì—…ë¡œë“œ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
            }
        });

        closeModal.onclick = function() {
            modal.style.display = "none";
            modalPlayer.pause();
            modalPlayer.src = "";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                modalPlayer.pause();
                modalPlayer.src = "";
            }
        }

        fetchLogs();
        setInterval(fetchLogs, 1000);
    </script>
</body>
</html>